<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Notes PWA - A powerful note-taking app">
    <meta name="theme-color" content="#09090b">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Notes%22,%22short_name%22:%22Notes%22,%22description%22:%22A%20powerful%20note-taking%20app%22,%22start_url%22:%22/%22,%22scope%22:%22/%22,%22display%22:%22standalone%22,%22orientation%22:%22portrait-primary%22,%22background_color%22:%22%2309090b%22,%22theme_color%22:%22%23f59e0b%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%2309090b' width='192' height='192'/><text x='50%' y='50%' font-size='100' fill='%23f59e0b' text-anchor='middle' dominant-baseline='middle' font-family='monospace' font-weight='bold'>N</text></svg>%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22},{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%2309090b' width='512' height='512'/><text x='50%' y='50%' font-size='250' fill='%23f59e0b' text-anchor='middle' dominant-baseline='middle' font-family='monospace' font-weight='bold'>N</text></svg>%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2309090b' width='100' height='100'/><text x='50' y='50' font-size='60' fill='%23f59e0b' text-anchor='middle' dominant-baseline='middle' font-family='monospace' font-weight='bold'>N</text></svg>">
    
    <title>Notes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js/dist/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/atom-one-dark.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #18181b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            color: #f4f4f5;
        }
        
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .glass-effect {
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(63, 63, 70, 0.5);
        }
        
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .editor-container {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .markdown-preview {
            font-family: 'Inter', sans-serif;
            line-height: 1.8;
        }
        
        .markdown-preview h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2em;
            font-weight: 700;
            color: #f59e0b;
            margin: 1em 0 0.5em 0;
        }
        
        .markdown-preview h2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5em;
            font-weight: 700;
            color: #f4f4f5;
            margin: 0.8em 0 0.4em 0;
        }
        
        .markdown-preview h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2em;
            font-weight: 700;
            color: #f4f4f5;
            margin: 0.6em 0 0.3em 0;
        }
        
        .markdown-preview p {
            margin-bottom: 1em;
            color: #e4e4e7;
        }
        
        .markdown-preview code {
            background-color: #27272a;
            color: #fbbf24;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }
        
        .markdown-preview pre {
            background-color: #1f2937;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            padding: 1em;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        .markdown-preview pre code {
            background-color: transparent;
            color: #e4e4e7;
            padding: 0;
            border-radius: 0;
        }
        
        .markdown-preview blockquote {
            border-left: 4px solid #f59e0b;
            padding-left: 1em;
            color: #a1a1aa;
            margin-bottom: 1em;
        }
        
        .markdown-preview ul, .markdown-preview ol {
            margin-left: 2em;
            margin-bottom: 1em;
        }
        
        .markdown-preview li {
            margin-bottom: 0.5em;
        }
        
        .markdown-preview a {
            color: #f59e0b;
            text-decoration: none;
            border-bottom: 1px dotted #f59e0b;
            transition: color 0.2s;
        }
        
        .markdown-preview a:hover {
            color: #fbbf24;
            border-bottom-color: #fbbf24;
        }
        
        .markdown-preview table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }
        
        .markdown-preview th, .markdown-preview td {
            border: 1px solid #3f3f46;
            padding: 0.75em;
            text-align: left;
        }
        
        .markdown-preview th {
            background-color: #27272a;
            font-weight: 600;
        }
        
        .markdown-preview tr:hover {
            background-color: rgba(245, 158, 11, 0.05);
        }
        
        .wiki-link {
            color: #f59e0b;
            cursor: pointer;
            border-bottom: 1px dotted #f59e0b;
        }
        
        .wiki-link:hover {
            color: #fbbf24;
            border-bottom-color: #fbbf24;
        }
        
        .drag-over {
            background-color: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
        }
        
        .node {
            cursor: pointer;
            stroke-width: 2px;
        }
        
        .node:hover {
            stroke-width: 3px;
        }
        
        .link {
            stroke: #52525b;
            stroke-opacity: 0.6;
        }
        
        .hljs {
            background-color: transparent !important;
            color: #e4e4e7;
        }
        
        .hljs-string { color: #86efac; }
        .hljs-number { color: #f59e0b; }
        .hljs-literal { color: #60a5fa; }
        .hljs-attr { color: #fbbf24; }
        .hljs-title { color: #f59e0b; }
        
        @supports (backdrop-filter: blur(1px)) {
            .glass {
                background: rgba(9, 9, 11, 0.7) !important;
                backdrop-filter: blur(10px);
            }
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-zinc-950">
    <!-- Firebase Setup Modal -->
    <!-- Main App Container -->
    <div id="app" class="w-full h-full flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800 px-4 py-3">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <!-- Left: Logo -->
                <div class="flex items-center gap-4">
                    <div class="font-mono font-bold text-lg text-amber-500">Notes</div>
                </div>

                <!-- Center: Search -->
                <div class="flex-1 max-w-md">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search notes..." class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2 pl-10 font-mono text-sm text-zinc-100 placeholder:text-zinc-600 focus:border-amber-500 focus:outline-none">
                        <svg class="absolute left-3 top-2.5 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                </div>

                <!-- Right: Buttons -->
                <div class="flex items-center gap-2">
                    <!-- SSO User Info -->
                    <div id="user-info" class="hidden items-center gap-2 px-3 py-1.5 bg-zinc-800 border border-zinc-700 rounded-lg">
                    </div>
                    <button id="settings-btn" class="p-2 hover:bg-zinc-800 rounded-lg text-zinc-400 hover:text-amber-400 smooth-transition" title="Settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </button>
                    <div id="connection-status" class="px-3 py-1.5 bg-zinc-800 border border-zinc-700 rounded-lg flex items-center gap-2">
                        <div class="pulse-dot w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="font-mono text-xs text-zinc-400">Ready</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Sidebar: File Tree -->
            <aside id="sidebar-left" class="w-64 bg-zinc-900 border-r border-zinc-800 overflow-hidden flex flex-col smooth-transition">
                <!-- Collapse button -->
                <div class="flex items-center justify-between px-4 py-2 border-b border-zinc-800">
                    <span class="text-xs font-mono font-bold text-zinc-500 uppercase tracking-wide">Files</span>
                    <button id="collapse-sidebar-left" class="p-1 hover:bg-zinc-800 rounded text-zinc-500 hover:text-amber-400 smooth-transition" title="Collapse sidebar">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                </div>
                <!-- New Note Button -->
                <div class="p-4 border-b border-zinc-800">
                    <button id="new-note-btn" class="w-full bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2.5 rounded-lg smooth-transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        New Note
                    </button>
                </div>

                <!-- File Tree -->
                <div id="file-tree" class="flex-1 overflow-y-auto px-2 py-3">
                    <div class="text-zinc-500 text-xs font-mono text-center py-8">No notes yet</div>
                </div>
            </aside>

            <!-- Left Sidebar Expand Tab (visible when collapsed) -->
            <button id="expand-sidebar-left" class="hidden bg-zinc-900 border-r border-zinc-800 px-1 py-0 flex-col items-center justify-start pt-3 hover:bg-zinc-800 smooth-transition text-zinc-500 hover:text-amber-400" title="Expand sidebar">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>

            <!-- Center: Editor -->
            <main class="flex-1 flex flex-col overflow-hidden bg-zinc-950">
                <!-- Editor Tabs -->
                <div id="editor-tabs" class="bg-zinc-900 border-b border-zinc-800 overflow-x-auto flex items-center">
                    <div class="text-zinc-500 text-xs font-mono px-4 py-3 w-full text-center">No notes open</div>
                </div>

                <!-- Collapsible Outline Tree -->
                <div id="outline-panel" class="bg-zinc-900/60 border-b border-zinc-800 hidden">
                    <button id="outline-toggle" class="w-full flex items-center gap-2 px-4 py-2 text-xs font-mono text-zinc-400 hover:text-amber-400 smooth-transition">
                        <svg id="outline-chevron" class="w-3 h-3 smooth-transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        <span class="text-zinc-500 uppercase tracking-wide">Outline</span>
                    </button>
                    <div id="outline-tree" class="px-4 pb-3 overflow-y-auto max-h-48"></div>
                </div>
                
                <!-- Editor Split View -->
                <div class="flex-1 flex overflow-hidden gap-0.5 bg-zinc-950">
                    <!-- Edit Pane -->
                    <div id="edit-pane" class="flex-1 flex flex-col overflow-hidden">
                        <textarea id="editor" class="flex-1 w-full bg-zinc-950 text-zinc-100 p-6 resize-none editor-container focus:outline-none" placeholder="Start typing..."></textarea>
                    </div>
                    
                    <!-- Preview Pane -->
                    <div id="preview-pane" class="flex-1 overflow-y-auto bg-zinc-950 p-6 markdown-preview">
                        <div id="preview-content"></div>
                    </div>
                </div>
                
                <!-- Status Bar -->
                <div class="bg-zinc-900 border-t border-zinc-800 px-4 py-2 text-xs font-mono text-zinc-500 flex justify-between items-center">
                    <div>
                        <span id="status-words">0 words</span> â€¢ <span id="status-chars">0 chars</span>
                    </div>
                    <div id="status-last-saved" class="text-zinc-600">Last saved: now</div>
                </div>
            </main>

            <!-- Right Sidebar Expand Tab (visible when collapsed) -->
            <button id="expand-sidebar-right" class="hidden bg-zinc-900 border-l border-zinc-800 px-1 py-0 flex-col items-center justify-start pt-3 hover:bg-zinc-800 smooth-transition text-zinc-500 hover:text-amber-400" title="Expand cheatsheet">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>

            <!-- Right Sidebar: Markdown Cheatsheet -->
            <aside id="sidebar-right" class="w-64 bg-zinc-900 border-l border-zinc-800 overflow-hidden flex flex-col smooth-transition">
                <!-- Header with collapse button -->
                <div class="flex items-center justify-between px-4 py-2 border-b border-zinc-800">
                    <span class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide">MD Cheatsheet</span>
                    <button id="collapse-sidebar-right" class="p-1 hover:bg-zinc-800 rounded text-zinc-500 hover:text-amber-400 smooth-transition" title="Collapse sidebar">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4">

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Headings</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300 space-y-0.5">
                            <div># Heading 1</div>
                            <div>## Heading 2</div>
                            <div>### Heading 3</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Emphasis</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300 space-y-0.5">
                            <div>**bold**</div>
                            <div>*italic*</div>
                            <div>~~strikethrough~~</div>
                            <div>`inline code`</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Links & Images</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300 space-y-0.5">
                            <div>[text](url)</div>
                            <div>![alt](image-url)</div>
                            <div>[[Wiki Link]]</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Lists</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300 space-y-0.5">
                            <div>- Unordered item</div>
                            <div>1. Ordered item</div>
                            <div>- [x] Task (done)</div>
                            <div>- [ ] Task (todo)</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Blockquote</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300">
                            <div>> Quote text</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Code Block</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300 space-y-0.5">
                            <div>```language</div>
                            <div>code here</div>
                            <div>```</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Table</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300 space-y-0.5">
                            <div>| Col 1 | Col 2 |</div>
                            <div>|-------|-------|</div>
                            <div>| data  | data  |</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Horizontal Rule</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300">
                            <div>---</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-mono font-bold text-amber-500 uppercase tracking-wide mb-2">Tags</h4>
                        <div class="bg-zinc-800 rounded-lg p-2.5 font-mono text-xs text-zinc-300">
                            <div>#tagname</div>
                        </div>
                    </div>

                </div>
            </aside>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-zinc-900 border border-zinc-700 rounded-xl p-6 max-w-md w-full mx-4">
            <h2 class="font-mono font-bold text-2xl text-amber-500 mb-4">Settings</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-zinc-500 font-mono uppercase tracking-wide block mb-2">Editor Mode</label>
                    <div class="flex gap-2">
                        <button id="mode-edit-only" class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs font-mono text-zinc-400 hover:text-zinc-100 smooth-transition">Edit</button>
                        <button id="mode-preview-only" class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs font-mono text-zinc-400 hover:text-zinc-100 smooth-transition">Preview</button>
                        <button id="mode-split" class="flex-1 px-3 py-2 bg-amber-500/20 border border-amber-500 rounded-lg text-xs font-mono text-amber-400 smooth-transition">Split</button>
                    </div>
                </div>
                
                <hr class="border-zinc-700">

                <div>
                    <label class="text-xs text-zinc-500 font-mono uppercase tracking-wide block mb-2">Data</label>
                    <button id="export-notes-btn" class="w-full px-3 py-2.5 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-xs font-mono text-zinc-300 smooth-transition mb-2">Export All Notes (JSON)</button>
                    <button id="clear-cache-btn" class="w-full px-3 py-2.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500 rounded-lg text-xs font-mono text-red-400 smooth-transition">Clear Cache</button>
                </div>
            </div>
            
            <div class="mt-6 flex gap-2">
                <button id="close-settings-btn" class="flex-1 px-3 py-2.5 bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold rounded-lg smooth-transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== APP STATE ====================
        const app = {
            notes: new Map(),
            currentNoteId: null,
            searchQuery: '',
            selectedTags: new Set(),
            mode: 'split', // split, edit-only, preview-only
            isNewNote: false,
            firebaseConfig: null,
            firebaseInitialized: false,
            db: null,
            firebaseAuth: null,
            unsubscribe: null,
            lastSaved: new Date(),
            autoSaveTimer: null,
            currentUser: null,
            isAdmin: false
        };

        // ==================== INITIALIZATION ====================
        function init() {
            setupServiceWorker();
            setupTailwind();
            setupSSOListener();
            setupEventListeners();
            // Start in temporary mode with localStorage
            loadNotesFromStorage();
            ensureNoteOpen();
            updateConnectionStatus(false, true);
        }

        function ensureNoteOpen() {
            // If no notes exist, create the welcome note
            if (app.notes.size === 0) {
                const id = createWelcomeNote();
                renderFileTree();
                openNote(id);
                return;
            }

            // If notes exist but none is open, open the first one
            if (!app.currentNoteId) {
                const firstNoteId = app.notes.keys().next().value;
                openNote(firstNoteId);
            }
        }

        function setupTailwind() {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                            mono: ['JetBrains Mono', 'monospace']
                        }
                    }
                }
            };
        }

        // ==================== SERVICE WORKER ====================
        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'notes-v1';
                    const urlsToCache = [
                        '/',
                        '/notes.html'
                    ];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => {
                                return cache.addAll(urlsToCache).catch(() => Promise.resolve());
                            })
                        );
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', (event) => {
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                        self.clients.claim();
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            }).catch(() => {
                                return caches.match('/notes.html');
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then((reg) => {
                    console.log('Service Worker registered');
                }).catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
            }
        }

        // ==================== FIREBASE ====================
        async function initializeFirebase() {
            try {
                if (!app.firebaseConfig) return;

                // Dynamically import Firebase modules
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js');
                const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');

                const firebaseApp = initializeApp(app.firebaseConfig);
                app.db = getFirestore(firebaseApp);
                app.firebaseAuth = getAuth(firebaseApp);

                // Subscribe to notes (uses per-user path if SSO user is signed in)
                await subscribeToNotes();

                app.firebaseInitialized = true;
                updateConnectionStatus(true, false);
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false, false);
            }
        }

        async function saveNoteToFirebase(note) {
            if (!app.db) {
                saveNoteToStorage(note);
                return;
            }

            try {
                const { setDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');

                const collPath = getNotesCollectionPath();
                await setDoc(doc(app.db, ...collPath, note.id), {
                    title: note.title,
                    content: note.content,
                    folder: note.folder || 'root',
                    tags: note.tags || [],
                    createdAt: note.createdAt || serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                updateLastSaved();
            } catch (error) {
                console.error('Error saving note:', error);
                saveNoteToStorage(note);
            }
        }

        async function deleteNoteFromFirebase(noteId) {
            if (!app.db) {
                deleteNoteFromStorage(noteId);
                return;
            }

            try {
                const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
                const collPath = getNotesCollectionPath();
                await deleteDoc(doc(app.db, ...collPath, noteId));
            } catch (error) {
                console.error('Error deleting note:', error);
                deleteNoteFromStorage(noteId);
            }
        }

        // ==================== SSO INTEGRATION ====================
        function getNotesCollectionPath() {
            if (app.currentUser) {
                return ['users', app.currentUser.uid, 'notes'];
            }
            return ['notes'];
        }

        function setupSSOListener() {
            window.addEventListener('message', async (event) => {
                const data = event.data;
                if (!data || data.type !== 'admin-auth') return;

                app.isAdmin = !!data.isAdmin;

                if (data.sso) {
                    app.currentUser = {
                        uid: data.sso.uid,
                        email: data.sso.email,
                        displayName: data.sso.displayName,
                        photoURL: data.sso.photoURL,
                        idToken: data.sso.idToken,
                    };

                    // Store Firebase config from SSO if provided
                    if (data.sso.firebaseConfig) {
                        app.firebaseConfig = data.sso.firebaseConfig;
                    }

                    // Sign in with Firebase Auth if available
                    if (app.firebaseAuth && data.sso.idToken) {
                        try {
                            const { GoogleAuthProvider, signInWithCredential } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
                            const credential = GoogleAuthProvider.credential(data.sso.idToken);
                            await signInWithCredential(app.firebaseAuth, credential);
                            console.log('Signed in via parent SSO');
                        } catch (err) {
                            console.warn('SSO sign-in failed, using token for display only:', err.message);
                        }
                    }

                    onUserSignedIn(app.currentUser);
                } else {
                    app.currentUser = null;

                    // Sign out from Firebase Auth
                    if (app.firebaseAuth) {
                        try {
                            const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
                            await signOut(app.firebaseAuth);
                        } catch (err) {
                            // Ignore sign-out errors
                        }
                    }

                    onUserSignedOut();
                }
            });
        }

        function onUserSignedIn(user) {
            updateUserInfoUI(user);
            updateConnectionStatus(true, false);
            // Switch to persistent per-user notes
            if (app.db) {
                subscribeToNotes();
            } else if (app.firebaseConfig) {
                initializeFirebase();
            }
        }

        function onUserSignedOut() {
            updateUserInfoUI(null);
            // Unsubscribe from Firestore and switch back to temporary localStorage
            if (app.unsubscribe) {
                app.unsubscribe();
                app.unsubscribe = null;
            }
            app.notes.clear();
            app.currentNoteId = null;
            loadNotesFromStorage();
            ensureNoteOpen();
            updateConnectionStatus(false, true);
        }

        function updateUserInfoUI(user) {
            const header = document.getElementById('user-info');
            if (!header) return;

            if (user) {
                header.classList.remove('hidden');
                header.classList.add('flex');
                const photoHTML = user.photoURL
                    ? `<img src="${user.photoURL}" alt="" style="width:28px;height:28px;border-radius:50%;border:1px solid rgba(245,158,11,0.5);" referrerpolicy="no-referrer">`
                    : `<div style="width:28px;height:28px;border-radius:50%;background:#f59e0b;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:#09090b;">${(user.displayName || user.email || '?')[0].toUpperCase()}</div>`;
                header.innerHTML = `
                    ${photoHTML}
                    <span class="font-mono text-xs text-zinc-400 max-w-[120px] truncate">${user.displayName || user.email}</span>
                `;
            } else {
                header.classList.add('hidden');
                header.classList.remove('flex');
                header.innerHTML = '';
            }
        }

        async function subscribeToNotes() {
            if (!app.db) return;

            try {
                const { collection, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');

                // Unsubscribe from previous listener
                if (app.unsubscribe) {
                    app.unsubscribe();
                    app.unsubscribe = null;
                }

                // Clear current notes before re-subscribing
                app.notes.clear();
                app.currentNoteId = null;

                const collPath = getNotesCollectionPath();
                const notesCol = collection(app.db, ...collPath);

                app.unsubscribe = onSnapshot(notesCol, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const data = change.doc.data();
                        if (change.type === 'added' || change.type === 'modified') {
                            const note = {
                                id: change.doc.id,
                                ...data,
                                updatedAt: data.updatedAt?.toDate?.() || new Date(),
                                createdAt: data.createdAt?.toDate?.() || new Date()
                            };
                            app.notes.set(note.id, note);
                        } else if (change.type === 'removed') {
                            app.notes.delete(change.doc.id);
                        }
                    });
                    renderFileTree();
                    ensureNoteOpen();
                });
            } catch (error) {
                console.error('Error subscribing to notes:', error);
            }
        }

        // ==================== LOCAL STORAGE ====================
        function saveNoteToStorage(note) {
            const notes = JSON.parse(localStorage.getItem('notes') || '{}');
            notes[note.id] = {
                ...note,
                createdAt: note.createdAt.toISOString(),
                updatedAt: note.updatedAt.toISOString()
            };
            localStorage.setItem('notes', JSON.stringify(notes));
            updateLastSaved();
        }

        function loadNotesFromStorage() {
            const notes = JSON.parse(localStorage.getItem('notes') || '{}');
            Object.values(notes).forEach(note => {
                app.notes.set(note.id, {
                    ...note,
                    createdAt: new Date(note.createdAt),
                    updatedAt: new Date(note.updatedAt)
                });
            });
            renderFileTree();
        }

        function deleteNoteFromStorage(noteId) {
            const notes = JSON.parse(localStorage.getItem('notes') || '{}');
            delete notes[noteId];
            localStorage.setItem('notes', JSON.stringify(notes));
        }

        function updateLastSaved() {
            app.lastSaved = new Date();
            const time = app.lastSaved.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('status-last-saved').textContent = `Last saved: ${time}`;
        }

        // ==================== EDITOR ====================
        function createNewNote() {
            const id = 'note-' + Date.now();
            const note = {
                id,
                title: 'Untitled Note',
                content: '',
                folder: 'root',
                tags: [],
                createdAt: new Date(),
                updatedAt: new Date()
            };
            
            app.notes.set(id, note);
            app.currentNoteId = id;
            app.isNewNote = true;
            saveNoteToFirebase(note);

            renderFileTree();
            openNote(id);
        }

        function createWelcomeNote() {
            const id = 'note-' + Date.now();
            const content = `# Launch Checklist â€” v1.0

> "Move fast, build things that matter."

Welcome to your **engineering workspace**. Write in the left pane and watch the *live preview* update on the right.

---

## Stack Overview

| Layer       | Technology      | Status   |
|-------------|-----------------|----------|
| Frontend    | React + Vite    | âœ… Live  |
| API         | Node / Express  | âœ… Live  |
| Database    | PostgreSQL      | âœ… Live  |
| Infra       | AWS / Terraform | ðŸš§ WIP  |

## Sprint Priorities

- [x] Set up CI/CD pipeline
- [x] Implement user auth (OAuth 2.0)
- [ ] Build dashboard analytics
- [ ] Load testing before launch
- [ ] Write API documentation

## Quick Reference

### Inline Code & Blocks

Use backticks for \`inline code\` like variable names or CLI commands.

\`\`\`python
# Fibonacci â€” because every whiteboard asks
def fib(n):
    a, b = 0, 1
    for _ in range(n):
        a, b = b, a + b
    return a
\`\`\`

\`\`\`javascript
// Express health-check endpoint
app.get('/health', (req, res) => {
  res.json({ status: 'ok', uptime: process.uptime() });
});
\`\`\`

### Text Formatting

- **Bold** for emphasis
- *Italic* for nuance
- ~~Strikethrough~~ for killed features
- \`code\` for technical terms

### Blockquotes

> Ship the MVP first. Optimize later.
> Perfection is the enemy of progress.

### Links & References

Link to resources: [Y Combinator](https://www.ycombinator.com) | [Hacker News](https://news.ycombinator.com)

Reference other notes with wiki-links: [[Untitled Note]]

### Tags

#startup #engineering #mvp #launch

---

*Start editing this note or create a new one from the sidebar. Happy building!*
`;
            const note = {
                id,
                title: 'Launch Checklist â€” v1.0',
                content,
                folder: 'root',
                tags: ['startup', 'engineering', 'mvp', 'launch'],
                createdAt: new Date(),
                updatedAt: new Date()
            };

            app.notes.set(id, note);
            saveNoteToFirebase(note);
            return id;
        }

        function openNote(noteId) {
            const note = app.notes.get(noteId);
            if (!note) return;

            app.currentNoteId = noteId;

            const editor = document.getElementById('editor');
            editor.value = note.content;

            // Always enforce split (Code + Preview) mode
            if (app.mode !== 'split') {
                app.mode = 'split';
                document.getElementById('edit-pane').classList.remove('hidden');
                document.getElementById('preview-pane').classList.remove('hidden');
                ['mode-edit-only', 'mode-preview-only', 'mode-split'].forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.remove('bg-amber-500/20', 'border', 'border-amber-500', 'text-amber-400');
                    btn.classList.add('bg-zinc-800', 'text-zinc-300');
                });
                const splitBtn = document.getElementById('mode-split');
                splitBtn.classList.remove('bg-zinc-800', 'text-zinc-300');
                splitBtn.classList.add('bg-amber-500/20', 'border', 'border-amber-500', 'text-amber-400');
            }
            // Ensure preview pane is visible even on first load
            document.getElementById('preview-pane').classList.remove('hidden');

            // Update tab
            renderEditorTabs();

            // Update preview
            updatePreview();

            // Update outline tree
            updateOutline();

            // Clear search highlight
            document.getElementById('search-input').value = '';
            app.searchQuery = '';

            // Scroll editor to top
            editor.scrollTop = 0;
        }

        function updatePreview() {
            const note = app.notes.get(app.currentNoteId);
            if (!note) return;
            
            const markdownText = note.content;
            const html = marked.parse(markdownText);
            
            // Post-process to add wiki-link support
            const processed = html.replace(
                /\[\[([^\]]+)\]\]/g,
                (match, title) => {
                    const linkedNote = findNoteByTitle(title.trim());
                    const className = linkedNote ? 'wiki-link' : 'wiki-link-missing';
                    const onclick = linkedNote ? `onclick="window.app.openNoteByTitle('${title.trim().replace(/'/g, "\\'")}'); return false;"` : '';
                    return `<a class="${className}" style="cursor: pointer;" ${onclick}>${title}</a>`;
                }
            );
            
            document.getElementById('preview-content').innerHTML = processed;
            
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach(el => {
                hljs.highlightElement(el);
            });
        }

        function updateEditorFromTextarea() {
            const note = app.notes.get(app.currentNoteId);
            if (!note) return;
            
            const content = document.getElementById('editor').value;
            note.content = content;
            note.updatedAt = new Date();

            // Auto-switch to split (Code + Preview) on first typing in a new note
            if (app.isNewNote && content.length > 0) {
                app.isNewNote = false;
                if (app.mode !== 'split') {
                    app.mode = 'split';
                    document.getElementById('edit-pane').classList.remove('hidden');
                    document.getElementById('preview-pane').classList.remove('hidden');
                    // Update settings mode button styles to reflect split active
                    ['mode-edit-only', 'mode-preview-only', 'mode-split'].forEach(id => {
                        const btn = document.getElementById(id);
                        btn.classList.remove('bg-amber-500/20', 'border', 'border-amber-500', 'text-amber-400');
                        btn.classList.add('bg-zinc-800', 'text-zinc-300');
                    });
                    const splitBtn = document.getElementById('mode-split');
                    splitBtn.classList.remove('bg-zinc-800', 'text-zinc-300');
                    splitBtn.classList.add('bg-amber-500/20', 'border', 'border-amber-500', 'text-amber-400');
                }
            }
            
            // Update word/char count
            const words = content.trim().split(/\s+/).filter(w => w).length;
            const chars = content.length;
            document.getElementById('status-words').textContent = `${words} words`;
            document.getElementById('status-chars').textContent = `${chars} chars`;
            
            // Auto-update preview and outline
            updatePreview();
            updateOutline();
            
            // Auto-save
            clearTimeout(app.autoSaveTimer);
            app.autoSaveTimer = setTimeout(() => {
                saveNoteToFirebase(note);
            }, 500);
        }

        // ==================== FILE TREE ====================
        function renderFileTree() {
            const tree = document.getElementById('file-tree');
            
            if (app.notes.size === 0) {
                tree.innerHTML = '<div class="text-zinc-500 text-xs font-mono text-center py-8">No notes yet</div>';
                return;
            }
            
            const folders = {};
            const rootNotes = [];
            
            // Group notes by folder
            app.notes.forEach(note => {
                if (!note.folder || note.folder === 'root') {
                    rootNotes.push(note);
                } else {
                    if (!folders[note.folder]) folders[note.folder] = [];
                    folders[note.folder].push(note);
                }
            });
            
            let html = '';
            
            // Root notes
            rootNotes.forEach(note => {
                const isActive = note.id === app.currentNoteId ? 'bg-zinc-800 border-l-2 border-amber-500' : '';
                html += `
                    <div class="px-2 py-1.5 cursor-pointer hover:bg-zinc-800 rounded-lg smooth-transition text-sm text-zinc-300 font-mono ${isActive}" data-note-id="${note.id}">
                        <div class="flex items-center justify-between gap-2 group">
                            <span class="truncate">${note.title || 'Untitled'}</span>
                            <button class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded text-red-400 text-xs delete-note-btn">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Folders
            Object.keys(folders).sort().forEach(folder => {
                html += `
                    <div class="mt-2">
                        <div class="px-2 py-1.5 text-xs font-mono text-amber-500 font-bold uppercase tracking-wide">${folder}</div>
                        <div class="ml-2">
                `;
                folders[folder].forEach(note => {
                    const isActive = note.id === app.currentNoteId ? 'bg-zinc-800 border-l-2 border-amber-500' : '';
                    html += `
                        <div class="px-2 py-1.5 cursor-pointer hover:bg-zinc-800 rounded-lg smooth-transition text-sm text-zinc-300 font-mono ${isActive}" data-note-id="${note.id}">
                            <div class="flex items-center justify-between gap-2 group">
                                <span class="truncate">${note.title || 'Untitled'}</span>
                                <button class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-500/20 rounded text-red-400 text-xs delete-note-btn">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });
            
            tree.innerHTML = html;
            
            // Add event listeners
            document.querySelectorAll('#file-tree [data-note-id]').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-note-btn')) {
                        openNote(el.dataset.noteId);
                    }
                });
            });
            
            document.querySelectorAll('.delete-note-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const noteId = btn.closest('[data-note-id]').dataset.noteId;
                    const note = app.notes.get(noteId);
                    if (confirm(`Delete "${note.title}"?`)) {
                        app.notes.delete(noteId);
                        if (app.currentNoteId === noteId) {
                            app.currentNoteId = null;
                            document.getElementById('editor').value = '';
                            document.getElementById('preview-content').innerHTML = '';
                            document.getElementById('editor-tabs').innerHTML = '<div class="text-zinc-500 text-xs font-mono px-4 py-3 w-full text-center">No notes open</div>';
                        }
                        deleteNoteFromFirebase(noteId);
                        renderFileTree();
                    }
                });
            });
        }

        function renderEditorTabs() {
            const tabsContainer = document.getElementById('editor-tabs');
            
            if (!app.currentNoteId) {
                tabsContainer.innerHTML = '<div class="text-zinc-500 text-xs font-mono px-4 py-3 w-full text-center">No notes open</div>';
                return;
            }
            
            const note = app.notes.get(app.currentNoteId);
            if (!note) return;
            
            tabsContainer.innerHTML = `
                <div class="flex items-center gap-0 flex-1 overflow-x-auto">
                    <div class="px-4 py-3 bg-zinc-800 border-b-2 border-amber-500 text-sm font-mono text-zinc-100 flex items-center gap-2 whitespace-nowrap">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        ${note.title || 'Untitled'}
                    </div>
                </div>
            `;
        }

        // ==================== SEARCH ====================
        function performSearch(query) {
            app.searchQuery = query.toLowerCase();
            renderFileTree();
            
            if (!query) return;
            
            // Filter notes by title/content
            const filtered = Array.from(app.notes.values()).filter(note => {
                return note.title.toLowerCase().includes(app.searchQuery) ||
                       note.content.toLowerCase().includes(app.searchQuery);
            });
            
            if (filtered.length === 0 && app.notes.size > 0) {
                document.getElementById('file-tree').innerHTML = `
                    <div class="text-zinc-500 text-xs font-mono text-center py-8">
                        No notes matching "${query}"
                    </div>
                `;
            }
        }

        // ==================== OUTLINE ====================
        function updateOutline() {
            const note = app.notes.get(app.currentNoteId);
            const panel = document.getElementById('outline-panel');
            const tree = document.getElementById('outline-tree');
            if (!note) { panel.classList.add('hidden'); return; }

            const headingRegex = /^(#{1,6})\s+(.+)$/gm;
            const headings = [];
            let match;

            while ((match = headingRegex.exec(note.content)) !== null) {
                headings.push({ level: match[1].length, text: match[2] });
            }

            if (headings.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');

            // Build nested tree structure
            function buildTree(items) {
                let html = '';
                let i = 0;
                while (i < items.length) {
                    const item = items[i];
                    // Collect children (headings with a deeper level)
                    const children = [];
                    let j = i + 1;
                    while (j < items.length && items[j].level > item.level) {
                        children.push(items[j]);
                        j++;
                    }
                    const hasChildren = children.length > 0;
                    const chevron = hasChildren
                        ? `<svg class="w-3 h-3 text-zinc-600 smooth-transition outline-item-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`
                        : `<span class="w-3 h-3 inline-block"></span>`;
                    html += `<div class="outline-node">`;
                    html += `<div class="flex items-center gap-1.5 py-1 cursor-pointer hover:text-amber-400 smooth-transition text-xs font-mono text-zinc-400 outline-item" style="padding-left:${(item.level - 1) * 10}px">`;
                    html += `${chevron}<span>${item.text}</span></div>`;
                    if (hasChildren) {
                        html += `<div class="outline-children">${buildTree(children)}</div>`;
                    }
                    html += `</div>`;
                    i = j;
                }
                return html;
            }

            tree.innerHTML = buildTree(headings);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function findNoteByTitle(title) {
            for (let note of app.notes.values()) {
                if (note.title.toLowerCase() === title.toLowerCase()) {
                    return note;
                }
            }
            return null;
        }

        function openNoteByTitle(title) {
            const note = findNoteByTitle(title);
            if (note) openNote(note.id);
        }

        function updateConnectionStatus(connected, isTemporary) {
            const status = document.getElementById('connection-status');
            if (isTemporary) {
                status.innerHTML = '<div class="w-2 h-2 bg-yellow-400 rounded-full"></div><span class="font-mono text-xs text-zinc-400">Temporary</span>';
            } else if (connected) {
                status.innerHTML = '<div class="pulse-dot w-2 h-2 bg-green-400 rounded-full"></div><span class="font-mono text-xs text-zinc-400">Synced</span>';
            } else {
                status.innerHTML = '<div class="w-2 h-2 bg-red-400 rounded-full"></div><span class="font-mono text-xs text-zinc-400">Offline</span>';
            }
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Editor
            document.getElementById('editor').addEventListener('input', updateEditorFromTextarea);
            document.getElementById('editor').addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;
                    e.target.value = e.target.value.substring(0, start) + '\t' + e.target.value.substring(end);
                    e.target.selectionStart = e.target.selectionEnd = start + 1;
                    updateEditorFromTextarea();
                }
            });
            
            // New Note
            document.getElementById('new-note-btn').addEventListener('click', createNewNote);
            
            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                performSearch(e.target.value);
            });
            
            // Left Sidebar Collapse/Expand
            document.getElementById('collapse-sidebar-left').addEventListener('click', () => {
                document.getElementById('sidebar-left').classList.add('hidden');
                document.getElementById('expand-sidebar-left').classList.remove('hidden');
                document.getElementById('expand-sidebar-left').classList.add('flex');
            });
            document.getElementById('expand-sidebar-left').addEventListener('click', () => {
                document.getElementById('sidebar-left').classList.remove('hidden');
                document.getElementById('expand-sidebar-left').classList.add('hidden');
                document.getElementById('expand-sidebar-left').classList.remove('flex');
            });

            // Right Sidebar Collapse/Expand
            document.getElementById('collapse-sidebar-right').addEventListener('click', () => {
                document.getElementById('sidebar-right').classList.add('hidden');
                document.getElementById('expand-sidebar-right').classList.remove('hidden');
                document.getElementById('expand-sidebar-right').classList.add('flex');
            });
            document.getElementById('expand-sidebar-right').addEventListener('click', () => {
                document.getElementById('sidebar-right').classList.remove('hidden');
                document.getElementById('expand-sidebar-right').classList.add('hidden');
                document.getElementById('expand-sidebar-right').classList.remove('flex');
            });

            // Outline Panel Toggle
            document.getElementById('outline-toggle').addEventListener('click', () => {
                const tree = document.getElementById('outline-tree');
                const chevron = document.getElementById('outline-chevron');
                tree.classList.toggle('hidden');
                chevron.style.transform = tree.classList.contains('hidden') ? 'rotate(-90deg)' : '';
            });

            // Outline tree item collapse (delegated)
            document.getElementById('outline-tree').addEventListener('click', (e) => {
                const item = e.target.closest('.outline-item');
                if (!item) return;
                const node = item.closest('.outline-node');
                const children = node.querySelector('.outline-children');
                if (!children) return;
                children.classList.toggle('hidden');
                const chevron = item.querySelector('.outline-item-chevron');
                if (chevron) {
                    chevron.style.transform = children.classList.contains('hidden') ? 'rotate(-90deg)' : '';
                }
            });

            // Settings
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.remove('hidden');
            });
            
            document.getElementById('close-settings-btn').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.add('hidden');
            });
            
            // Settings buttons
            document.getElementById('mode-edit-only').addEventListener('click', () => {
                app.mode = 'edit-only';
                document.getElementById('preview-pane').classList.add('hidden');
                document.getElementById('edit-pane').classList.remove('hidden');
                updateModeButtons();
            });
            
            document.getElementById('mode-preview-only').addEventListener('click', () => {
                app.mode = 'preview-only';
                document.getElementById('edit-pane').classList.add('hidden');
                document.getElementById('preview-pane').classList.remove('hidden');
                updateModeButtons();
            });
            
            document.getElementById('mode-split').addEventListener('click', () => {
                app.mode = 'split';
                document.getElementById('edit-pane').classList.remove('hidden');
                document.getElementById('preview-pane').classList.remove('hidden');
                updateModeButtons();
            });
            
            document.getElementById('export-notes-btn').addEventListener('click', () => {
                const json = JSON.stringify(Array.from(app.notes.values()), null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'notes-export.json';
                a.click();
                URL.revokeObjectURL(url);
            });
            
            document.getElementById('clear-cache-btn').addEventListener('click', () => {
                if (confirm('Clear all local cache? This will not affect cloud data.')) {
                    localStorage.removeItem('notes');
                    if ('caches' in window) {
                        caches.keys().then(names => {
                            names.forEach(name => caches.delete(name));
                        });
                    }
                    location.reload();
                }
            });
            
            // Close modals on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('settings-modal').classList.add('hidden');
                }
            });
        }

        function updateModeButtons() {
            document.getElementById('mode-edit-only').classList.toggle('bg-amber-500/20');
            document.getElementById('mode-edit-only').classList.toggle('border');
            document.getElementById('mode-edit-only').classList.toggle('border-amber-500');
            document.getElementById('mode-edit-only').classList.toggle('text-amber-400');
            document.getElementById('mode-edit-only').classList.toggle('bg-zinc-800');
            document.getElementById('mode-edit-only').classList.toggle('text-zinc-300');
            
            document.getElementById('mode-preview-only').classList.toggle('bg-amber-500/20');
            document.getElementById('mode-preview-only').classList.toggle('border');
            document.getElementById('mode-preview-only').classList.toggle('border-amber-500');
            document.getElementById('mode-preview-only').classList.toggle('text-amber-400');
            document.getElementById('mode-preview-only').classList.toggle('bg-zinc-800');
            document.getElementById('mode-preview-only').classList.toggle('text-zinc-300');
            
            document.getElementById('mode-split').classList.toggle('bg-amber-500/20');
            document.getElementById('mode-split').classList.toggle('border');
            document.getElementById('mode-split').classList.toggle('border-amber-500');
            document.getElementById('mode-split').classList.toggle('text-amber-400');
            document.getElementById('mode-split').classList.toggle('bg-zinc-800');
            document.getElementById('mode-split').classList.toggle('text-zinc-300');
        }

        // Make app accessible globally
        window.app = {
            openNote,
            openNoteByTitle
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
